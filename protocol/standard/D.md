##  Protocol D: Wifi & Mcu

	Make By: Moore Huang, nosun, wangyf
	version: v1.5  

### 一、设计原则与目标

本协议为WiFi与MCU之间的通信协议

+ **指令下发**：WiFi下发指令给MCU
+ **状态上报**：MCU状态变化后，及时上报WiFi模块
+ **传输稳定**：保证串口通信的稳定性

### 二、协议要点

+ **协议组成：**
	
	协议分为协议头，协议长度，协议体（包含键值对与分隔符，或者二进制串），结束符

+ **协议长度与分隔符：**

	包分隔符为 `\n` (0x0A)，不计入协议长度。两个键值对之间的分割符为 `\0` (0x00)，计入协议长度。

+ **协议体与编码：**
	
	采用键值对的形式表示状态或者命令，默认采用 ASCII 编码。
 	
	但如果考虑传输效率，需要采用二进制方式传输协议体的内容。具体内容格式由MCU与云端协商，WiFi模块无需解析，但需要将T口和L口传输的 `data` 字段进行**BASE64**解码后转发给MCU，将MCU上报的二进制body进行BASE64加密，封装到`data` 字段中上报给T口和L口。

	MCU如果有二进制传输的需求，需要在 `基础信息` 中增加 `isbin` 的字段，值赋值为1。这样WiFi模块在login登录之后查到此字段，便对MCU上报与向MCU下发的数据body进行BASE64编解码
	

### 三、通用说明

所有串口协议前增加plen，长度2字节，后面接实际协议，如下：

	协议头|协议长度|协议体|结束符
    ----|----|----|----
	0xAA|plen|body|0x0A

> plen为协议体长度，字长2字节。整条协议包长度上限为512字节   
> 
> 每条协议包中键值对("xxx::xxx")的数量上限为30个
> 
> 如果有多个键值对，两两之间通过 `\0` (0x00) 分隔
> 
> 最后一个键值对后用`\n` (0x0A) 作为结束符
> 
> `\n` 不计入plen, `\0`计入plen


##### 名词&缩写约定

+ pid: (Product ID): 为产品ID，长度16以内，字符，用于标示指定产品
+ pkey: (Product Key): 长度5，整数，与当前产品相对的密钥
+ mv: (mcu version): MCU版本号

+ [xxx]: 被'[',']'包围的JSON项为传输中非必需包含项

### 四、协议内容

#### 1. 查询设备基础信息

**Request (WiFi to MCU)**

	命令号|
    -----|
    0x01|

**Response (MCU to WiFi)**

	命令号|变量名|隔离符|值|当前结束符|...|结束符
    -----|----|----|----|----|----|----
    0x01 |key | :  |value| 0x00 |...| 0x0A


>此协议WiFi上电后出发，目的一是为测试串口通信是否正常，二是为获取主控设备的基础信息，用于向服务器注册.  
>
>重要：回复此响应包后，MCU需立刻上传全部基础信息（见下表）  
>
>此处多个键值对由`\0`来分隔，即重复变量名到`\0`隔离符的格式  
>除`命令号0x01`和结束符，其余皆为ASCII字符值

键值对可包括下表所列信息：

	变量key|value|长度|是否必选|描述
	----|-----|---------|----|----
    pid |char |16位以内  |必选|产品ID （建议对应产品型号）
	pkey|num  |5位定长   |必选|产品对应注册密钥
    mv  |float|10位以内  |可选|mcu版本号，例如1.1，2.3
    bin |num  |1位 0/1   |可选|键值是否采用二进制传输，默认为0

>1. 厂家可根据需求自定义添加键值对，不过类型必须为字符，此数据将直接经WiFi模块封包后发给服务器  
>2. 其中pid, pkey为云平台服务商提供，响应包中必需包括。mv，isbin可选择。  
>3. 此处WiFi模块中"data"项目数上限为30个
	
#### 2. 设备控制

**Request (WiFi to MCU)**

	命令号|键值对|分隔符|...|结束符
	----|-------|-----|----|----
	0x02|key : value|0x00|...|0x0A

> 此处将服务器的命令抽象为变量，如服务器要控制一个开关量，则可定义一个变量，通过下载此变量的值，达到控制设备的命令，例：switch:1，则可理解为打开插座，key value 为**ASCII码**。
    
Or

	命令号|二进制串|结束符
	----|------|----
    0x02|binary|0x0A

>采用二进制传输，将 `data` 经过BASE64解码后下发给MCU

#### 3. 上传状态

**Request (MCU to WiFi)**

	命令号|键值对|分隔符|...|结束符
	----|-----|------|----|----
    0x03|key : value|0x00|...|0x0A

> 当主控设备MCU的状态发生变化时，需立刻发送变化后的状态给WiFi模块，从而上传到服务器。

Or

	命令号|二进制串|结束符
	-----|-----|-----
    0x03|binary|0x0A

>采用二进制传输，将 `data` 经过BASE64编码后放在`data`中上报给T口和L口

#### 4. 错误事件

**Request (WiFi to MCU)**

	命令号|错误号
	----|----
	0x04|ret

> 当WiFI模块与服务器间的连接断开，即上传状态命令所上传的数据无法传到服务器时，WiFi模块将向MCU发送此错误事件，通知MCU网络已断开，用户可根据实际情况选择，非必须。

ret的返回值如下：

	ret值|解释
	---|----
	200|成功收到协议包
	500|服务器与WiFi模块间的连接断开，无法完成客户请求
    501|不支持此协议

#### 5. 查询/上报网络连接状态
**Request (MCU to WiFi)**

	命令号|
    ----|
	0x05|

**Response (WiFi to MCU)**

	命令号|配置状态|连接状态|在线状态
	-----|-----|-----|----
    0x05|config|link|online

如果网络状态发生变化，WiFi模块会**异步**上报此状态

**参数说明&取值范围：**

	参数名|取值范围|说明
	-----|-----|-----
	config| 1/0(已配置/未配置过) | 用于指示当前WiFi模块是否已配置到路由器
	link| 1/0(已连接/未连接) | 用于指示当前WiFi模块是否已连接到路由器
	online| 1/0(在线/离线) | 用于指示当前WiFi模块是否连接到服务器

#### 6.查询设备状态信息

**Request (WiFi to Mcu)**

	命令号|
	----|
	0x06|

**Request (MCU to WiFi)**

    命令号|键值对|分隔符|...|结束符
	-----|-----|-----|-----|-----
	0x03|key : value|0x00|...|0x0A

Or

 	命令号|二进制串|结束符
	-----|-----|-----
    0x03|binary|0x0A

> 此接口用于Server或App查询设备的状态量时使用。设备MCU收到WiFi传过来的查询指令，需立刻上报设备的当前所有的状态量。

#### 7. 通过串口开启Smartlink

**Request(Mcu to Wifi)**

	命令号|
	----|
	0x07|

**Request(WiFi to Mcu)**

进入Smartlink状态的响应

	命令号|结果|结束符
	----|----|----
	0x07|0xC8|0x0A

配网的结果，通过 **``0x05``** 指令**异步**上报

	命令号|配置状态|连接状态|在线状态
	----|------|----|------
    0x05|config|link|online

#### 8 查询/上报WiFi信号强度

**Request(Mcu to Wifi)**

	命令号|
	----|
	0x08|

**Request(WiFi to Mcu)**

获取WiFi信号强度。例如强度为80% （16进制0x50）

	命令号|结果|结束符
	----|----|----
	0x08|0x50|0x0A

如果WiFi的强度变化，WiFi模块会**异步**上报此状态
